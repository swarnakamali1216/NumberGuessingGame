{% extends "base.html" %}
{% block content %}

<div class="gaming-container py-4">
    <div class="text-center mb-4">
        <h1 class="gaming-title"><i class="fas fa-user-circle"></i> YOUR PROFILE</h1>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Profile Header -->
            <div class="gaming-card profile-header mb-4">
                <div class="text-center">
                    <div class="profile-avatar-container mb-3">
                        {% if current_user.avatar_url %}
                        <img src="{{ current_user.avatar_url }}" alt="Profile" class="profile-avatar-img rounded-circle"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="profile-avatar fallback-avatar" style="display: none;">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        {% else %}
                        <div class="profile-avatar">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        {% endif %}
                    </div>
                    <h2 class="mt-3 gaming-title">{{ player_name }}</h2>
                    <p class="text-muted">Level: <span class="badge bg-primary">{{ (profile.games_won or 0) +
                            (profile.games_lost or 0) }}</span></p>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon wins">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ profile.games_won if profile.games_won else 0 }}</h3>
                            <p>Wins</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon losses">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ profile.games_lost if profile.games_lost else 0 }}</h3>
                            <p>Losses</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon best">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ profile.best_score if profile.best_score else 'N/A' }}</h3>
                            <p>Best Score</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon streak">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ profile.streak if profile.streak else 0 }}</h3>
                            <p>Win Streak</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="gaming-card mb-4">
                <h5 class="gaming-label mb-3"><i class="fas fa-medal"></i> Achievements</h5>
                {% if profile.achievements %}
                <div class="achievements-list">
                    {% for achievement in profile.achievements %}
                    <div class="achievement-badge">
                        <i class="fas fa-badge"></i> {{ achievement }}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">No achievements yet. Keep playing to unlock them!</p>
                {% endif %}
            </div>

            <!-- Detailed Stats -->
            <div class="gaming-card mb-4">
                <h5 class="gaming-label mb-3"><i class="fas fa-chart-bar"></i> Detailed Stats</h5>
                <table class="table table-dark mb-0">
                    <tbody>
                        <tr>
                            <td><i class="fas fa-gamepad"></i> Total Games</td>
                            <td><strong>{{ (profile.games_won or 0) + (profile.games_lost or 0) }}</strong></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-percentage"></i> Win Rate</td>
                            <td>
                                <strong>
                                    {% set total = (profile.games_won or 0) + (profile.games_lost or 0) %}
                                    {% if total > 0 %}
                                    {{ "%.1f"|format(((profile.games_won or 0) / total) * 100) }}%
                                    {% else %}
                                    0%
                                    {% endif %}
                                </strong>
                            </td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-calculator"></i> Total Attempts</td>
                            <td><strong>{{ profile.total_attempts if profile.total_attempts else 0 }}</strong></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-align-center"></i> Avg Attempts/Win</td>
                            <td>
                                <strong>
                                    {% if (profile.games_won or 0) > 0 %}
                                    {{ "%.1f"|format(profile.total_attempts / profile.games_won) }}
                                    {% else %}
                                    0
                                    {% endif %}
                                </strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Chart -->
            <div class="gaming-card mb-4">
                <h5 class="gaming-label mb-3"><i class="fas fa-chart-pie"></i> Performance Chart</h5>
                <div style="height: 300px; position: relative;">
                    <canvas id="statsChart" data-won="{{ profile.games_won or 0 }}"
                        data-lost="{{ profile.games_lost or 0 }}">
                    </canvas>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2 d-md-flex justify-content-center">
                <a href="/game" class="btn gaming-btn-primary btn-lg">
                    <i class="fas fa-play-circle"></i> Back to Game
                </a>
                <a href="/leaderboard" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-trophy"></i> View Leaderboard
                </a>
                <a href="/logout" class="btn btn-outline-danger btn-lg">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        document.addEventListener("DOMContentLoaded", function () {
            const chartCanvas = document.getElementById('statsChart');
            if (!chartCanvas) return;

            // Get context for Chart.js
            const ctx = chartCanvas.getContext('2d');

            // Data from HTML attributes to keep JS block clean of Jinja2 tags (solves lint errors)
            const gWon = parseInt(chartCanvas.dataset.won) || 0;
            const gLost = parseInt(chartCanvas.dataset.lost) || 0;
            const tGames = gWon + gLost;
            const wRate = tGames > 0 ? Math.round((gWon / tGames) * 100) : 0;

            // Neon Colors
            const gamingColors = {
                cyan: '#00d9ff',
                pink: '#ff006e',
                dark: '#1a1a2e',
                text: '#e0e0e0'
            };

            // Center Text Plugin
            const centerTextPlugin = {
                id: 'centerText',
                beforeDraw: function (chart) {
                    const { width, height, ctx } = chart;

                    ctx.restore();
                    const fontSize = (height / 120).toFixed(2);
                    ctx.font = "bold " + fontSize + "em sans-serif";
                    ctx.textBaseline = "middle";
                    ctx.fillStyle = gamingColors.text;

                    const text = wRate + "%";
                    const textX = Math.round((width - ctx.measureText(text).width) / 2);
                    const textY = height / 2;

                    ctx.fillText(text, textX, textY);

                    ctx.font = "normal " + (fontSize * 0.4) + "em sans-serif";
                    ctx.fillStyle = "#888";
                    const subtext = "Win Rate";
                    const subtextX = Math.round((width - ctx.measureText(subtext).width) / 2);
                    const subtextY = (height / 2) + 20;

                    ctx.fillText(subtext, subtextX, subtextY);
                    ctx.save();
                }
            };

            // Create Chart
            new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses'],
                    datasets: [{
                        data: [gWon, gLost],
                        backgroundColor: [gamingColors.cyan, gamingColors.pink],
                        borderColor: gamingColors.dark,
                        borderWidth: 4,
                        hoverOffset: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: gamingColors.text,
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 46, 0.95)',
                            titleColor: gamingColors.cyan,
                            bodyColor: gamingColors.text,
                            borderColor: gamingColors.cyan,
                            borderWidth: 1,
                            displayColors: true,
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = tGames > 0 ? Math.round((value / tGames) * 100) + '%' : '0%';
                                    return ` ${label}: ${value} (${percentage})`;
                                }
                            }
                        }
                    }
                },
                plugins: [centerTextPlugin]
            });
        });
    })();
</script>

{% endblock %}